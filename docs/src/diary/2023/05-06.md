---
date: 2023-05-06
category: IT
---

# Spring Cloud Eureka 配置用户认证

在使用 Spring Cloud Eureka 时如果不配置用户认证的话网站会存在未授权访问漏洞。导致攻击者在未授权情况下可直接查看到服务器的配置信息

<!-- more -->

Spring Cloud 是一个基于 Spring Boot 实现的云应用开发工具，它是若干个框架的集合，提供了全套的分布式系统解决方案。Spring Boot 专注于快速、方便集成的单个个体，而 Spring Cloud 是关注全局的服务治理框架。Eureka 是 Spring Cloud 的一部分，它是一个基于 REST 的服务，用于定位服务，以实现云端中间层服务发现和故障转移。Eureka 是 Netflix 开源的一个组件，Spring Cloud 将其集成在了自己的子项目中

在 Spring Cloud 1.x 版本中，如果使用的是 Security 4.x 版本，则无需配置 `security.basic.enabled=true`，因为它是默认启用的。但是在 Spring Cloud 2.x 版本中，如果使用的是 Security 5.x 版本，则不再默认启用 `security.basic.enabled=true`，而是默认启用表单验证模式，而 Eureka 在基于 Security 5.x 中配置用户认证需要手动开启 HTTP Basic Authentication

## 基于 Spring Cloud 1.x 配置

1. 在 Eureka 服务端的 pom 文件中添加 Security 依赖

    ```xml
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-security</artifactId>
    </dependency>
    ```

2. 修改 Eureka 服务端的应用程序配置文件 application.properties 或 application.yml

    ```properties
    # 服务端口
    server.port=9090
    # 认证用户名
    spring.security.user.name=name
    # 认证密码（不要设置成弱口令）
    spring.security.user.password=password
    # 应用实例主机名
    eureka.instance.hostname=localhost
    # 是否将自己注册到 Eureka 服务中，因为该应用本身就是注册中心，因此不需要再注册自己（集群的时候为true）
    eureka.client.register-with-eureka=false
    # 是否从 Eureka 中获取注册信息，因为该应用本身就是注册中心，因此不会在该应用中检索服务信息
    eureka.client.fetch-registry=false
    # 指定 Eureka 服务器的地址，如果服务注册中心为高可用集群时，多个注册中心地址以逗号分隔
    eureka.client.service-url.defaultZone=http://${spring.security.user.name}:${spring.security.user.password}@${eureka.instance.hostname}:${server.port}/eureka/
    ```
3. 启动 Eureka 服务端进行测试验证

   在浏览器上访问注册中心地址：http://localhost:9090 就会进行 HTTP Basic Authentication

   ![](https://img.sherry4869.com/blog/diary/2023/05/img_1.png)

   ![](https://img.sherry4869.com/blog/diary/2023/05/img_2.png)

   此时注册中心中提示没有可用的实例，此时我们可以注册所需的服务

4. 注册服务

   修改需要注册的服务端的应用程序配置文件 application.properties 或 application.yml

    ```properties
    # 服务端口
    server.port=9091
    # 应用程序名称
    spring.application.name=test
    # 服务提供者使用你指定的 IP 地址去注册
    eureka.instance.prefer-ip-address=true
    # 标识服务实例，默认值为 ${spring.application.name}:${spring.application.instance_id:${server.port}}
    eureka.instance.instance-id=${spring.cloud.client.ip-address}:${server.port}
    # 指定 Eureka 服务器的地址
    eureka.client.service-url.defaultZone=http://name:password@localhost:9090/eureka
    ```

   启动服务后刷新注册中心地址可以看到当前注册的实例列表里有 TEST 实例

   ![](https://img.sherry4869.com/blog/diary/2023/05/img_3.png)

## 基于 Spring Cloud 2.x 配置

1. 在 Eureka 服务端的 pom 文件中添加 Security 依赖

    ```xml
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-security</artifactId>
    </dependency>
    ```

2. 修改 Eureka 服务端的应用程序配置文件 application.properties 或 application.yml

    ```properties
    # 服务端口
    server.port=9090
    # 认证用户名
    spring.security.user.name=name
    # 认证密码（不要设置成弱口令）
    spring.security.user.password=password
    # 应用实例主机名
    eureka.instance.hostname=localhost
    # 是否将自己注册到 Eureka 服务中，因为该应用本身就是注册中心，因此不需要再注册自己（集群的时候为true）
    eureka.client.register-with-eureka=false
    # 是否从 Eureka 中获取注册信息，因为该应用本身就是注册中心，因此不会在该应用中检索服务信息
    eureka.client.fetch-registry=false
    # 指定 Eureka 服务器的地址，如果服务注册中心为高可用集群时，多个注册中心地址以逗号分隔
    eureka.client.service-url.defaultZone=http://${spring.security.user.name}:${spring.security.user.password}@${eureka.instance.hostname}:${server.port}/eureka/
    ```

3. 在 Eureka 服务端新增一个安全认证类

    ```java
    @Configuration
    @EnableWebSecurity
    public class WebSecurityConfig extends WebSecurityConfigurerAdapter {
    
        @Override
        protected void configure(HttpSecurity http) throws Exception {
            // 禁用 CSRF 防护
            http.csrf().disable();
            // 手动配置用户认证：启用 HTTP 基本身份验证，并要求用户进行身份验证。这意味着如果用户未通过身份验证，则无法访问受保护的资源
            http.authorizeRequests().anyRequest().authenticated().and().httpBasic();
        }
    
    }
    ```
   
    Spring Cloud 2.x 版本中的 Eureka-client 使用了 Spring Security 5.x 版本，而 Spring Security 5.x 版本默认启动了 CSRF 保护。因此任何一次服务请求默认都需要 CSRF 的 Token。而 Eureka-client 将无法向 Eureka-server 注册服务，因为它是一个服务注册中心无法生成 CSRF 令牌。所以需要禁用 CSRF 防护

    因为 Eureka-server 需要对服务进行身份验证，以确保只有受信任的服务才能注册到 Eureka-server 中。如果不手动配置用户认证，则 Eureka-client 将无法通过身份验证，因此无法向 Eureka-server 注册服务

4. 启动 Eureka 服务端进行测试验证

    在浏览器上访问注册中心地址：http://localhost:9090 就会进行 HTTP Basic Authentication

    ![](https://img.sherry4869.com/blog/diary/2023/05/img_1.png)

    ![](https://img.sherry4869.com/blog/diary/2023/05/img_2.png)

    此时注册中心中提示没有可用的实例，此时我们可以注册所需的服务

5. 注册服务

    修改需要注册的服务端的应用程序配置文件 application.properties 或 application.yml

    ```properties
    # 服务端口
    server.port=9091
    # 应用程序名称
    spring.application.name=test
    # 服务提供者使用你指定的 IP 地址去注册
    eureka.instance.prefer-ip-address=true
    # 标识服务实例，默认值为 ${spring.application.name}:${spring.application.instance_id:${server.port}}
    eureka.instance.instance-id=${spring.cloud.client.ip-address}:${server.port}
    # 指定 Eureka 服务器的地址
    eureka.client.service-url.defaultZone=http://name:password@localhost:9090/eureka
    ```

    启动服务后刷新注册中心地址可以看到当前注册的实例列表里有 TEST 实例

    ![](https://img.sherry4869.com/blog/diary/2023/05/img_3.png)