---
category: IT
tag: 数据库
order: 1
article: false
---

# 索引类型

PostgreSQL 支持几种不同类型的索引：`B-tree`、`Hash`、`GiST`、`SP-GiST`、`GIN` 和 `BRIN`。每种索引类型使用不同的存储结构和算法来应对不同类型的查询。不同的数据可能要采用不同的索引类型

PostgreSQL 默认使用 B-tree 索引类型，因为它最适合最常见的查询。你在使用 `CREATE INDEX` 语句创建索引时，如果不知道索引类型，默认采用 B-tree

## B-tree 索引

`B-tree`（Balanced Tree）索引是一种常见且广泛使用的索引结构，在数据库管理系统中被广泛采用。它是一种自平衡的树形结构，用于支持高效的数据查找和范围查询

每当索引列涉及使用以下运算符之一的比较时，PostgreSQL 查询规划器将考虑使用 B-tree 索引：

- `<`

- `<=`

- `=`

- `>=`

- `BETWEEN`

- `IN`

- `IS NULL`

- `IS NOT NULL`

此外，如果模式是一个常量并且在模式的开头是锚点，查询规划器可以对涉及模式匹配运算符 `LIKE` 和 `~` 的查询使用 B-tree 索引，例如：

```sql
column_name LIKE 'foo%'
column_name LKE 'bar%'
column_name  ~ '^foo'
```

对于以模式开头并使用 `LIKE` 或 `~` 进行前缀匹配的查询，例如 `column_name LIKE 'foo%'` 或 `column_name ~ 'foo'`，可以利用 `B-tree` 索引进行快速定位。这是因为 `B-tree` 索引按照排序顺序存储数据，并且可以有效地支持范围查询，因此可以利用索引的有序性，快速定位满足特定模式匹配条件的值

然而，对于以模式结尾的查询，例如 `column_name LIKE '%bar'`，由于模式的通配符位于开头，而不是在开头的锚点位置，这导致无法有效利用 `B-tree` 索引。因为 `B-tree` 索引是按照排序顺序存储数据的，而以通配符开头的模式查询无法利用索引的有序性，需要进行全表扫描来找到匹配的结果

要利用 `B-tree` 索引进行后缀匹配，可以考虑使用反向索引（Reverse Index）或其他技术，或者在需要后缀匹配的情况下使用其他类型的索引，如全文搜索索引（Full-Text Search Index）

综上所述，对于以模式开头并具有锚点的查询，可以使用 `B-tree` 索引进行加速。对于以模式结尾或包含通配符在非锚点位置的查询，则无法利用 `B-tree` 索引，可能需要其他索引或技术来支持该类查询

---

以下是使用 `B-tree` 索引的一般步骤：

1. 选择合适的列：选择一个或多个适合构建 `B-tree` 索引的列。通常，选择具有较高唯一性和排序性能的列会获得更好的 `B-tree` 索引性能

2. 创建 `B-tree` 索引：使用数据库管理系统提供的语法创建 `B-tree` 索引。例如，在 PostgreSQL 中，可以使用以下语法创建 `B-tree` 索引：

    ```sql
    CREATE INDEX index_name ON table_name (column_name);
    ```

   这将在 table_name 表的 column_name 列上创建名为 index_name 的 `B-tree` 索引

3. 查询时使用 `B-tree` 索引：在查询中使用 `B-tree` 索引以获得快速的查找性能。数据库管理系统通常会自动选择是否使用 `B-tree` 索引来处理查询

    ```sql
    SELECT * FROM table_name WHERE column_name = 'value';
    ```

    上述查询示例中，数据库管理系统可能会使用 `B-tree` 索引来快速定位具有特定值 'value' 的行

## 哈希索引

哈希索引（Hash Index）是一种在数据库中用于快速查找的索引结构。它使用哈希函数将索引键映射到索引桶（或槽位）中，以便快速定位和访问数据

哈希索引只能处理简单的相等比较 (=)。这意味着每当索引列使用 `=` 运算符进行比较时，查询计划器将考虑使用哈希索引

以下是哈希索引的一些特点和适用场景：

1. 快速查找：哈希索引使用哈希函数将索引键映射到特定的桶中，因此在理想情况下，哈希索引的查找时间复杂度为 O(1)。这使得在索引列上进行等值查询非常高效

2. 适合等值查询：哈希索引在处理等值查询时表现出色。例如，当使用完全匹配的条件进行查询时，哈希索引可以直接定位到特定的索引桶中

3. 不支持范围查询和排序：哈希索引是基于哈希函数的，它将键映射到不同的桶中。由于哈希函数的散列性质，哈希索引不支持范围查询、排序和部分匹配查询。这是因为哈希函数将相似的键映射到不同的桶中，无法保证有序性

4. 内存要求较高：哈希索引通常需要在内存中维护，因为索引键的哈希值用于定位索引桶。如果索引数据量较大，可能需要较大的内存空间来容纳索引

5. 不适用于高并发和频繁更新的场景：哈希索引在数据插入和删除时可能需要进行重建或重新哈希，这会导致性能开销。因此，对于频繁更新和高并发的场景，哈希索引可能不是最佳选择

总的来说，哈希索引适用于等值查询较为频繁、范围查询较少、排序不是主要需求的场景。它可以提供快速的查找性能，但在一些特定的查询和更新操作上存在一些限制。在选择索引类型时，需要根据具体的应用需求和查询模式进行评估和权衡

---

以下是使用哈希索引的一般步骤：

1. 选择合适的列：选择一个或多个适合构建哈希索引的列。通常，选择具有较低唯一性和高均匀分布的列会获得更好的哈希索引性能

2. 创建哈希索引：使用数据库管理系统提供的语法创建哈希索引。例如，在 PostgreSQL 中，可以使用以下语法创建哈希索引：

    ```sql
    CREATE INDEX index_name ON table_name USING hash (column_name);
    ```

    这将在 table_name 表的 column_name 列上创建名为 index_name 的哈希索引

3. 查询时使用哈希索引：在查询中使用哈希索引以获得快速的查找性能。数据库管理系统通常会自动选择是否使用哈希索引来处理查询

    ```sql
    SELECT * FROM table_name WHERE column_name = 'value';
    ```

    上述查询示例中，数据库管理系统可能会使用哈希索引来快速定位具有特定值 'value' 的行

## GIN 索引

`GIN`（Generalized Inverted Index）索引是 PostgreSQL 中的一种特殊类型的索引，用于支持全文搜索和复杂数据类型的查询。它主要用于对包含多个元素的数据进行高效的查找和匹配

以下是 `GIN` 索引的一些特点和适用场景：

1. 全文搜索：`GIN` 索引在处理全文搜索时非常高效。它适用于包含文本、字符串或其他结构化数据的列，可以提供快速的关键字匹配和查询扩展

2. 支持多个元素的列：`GIN` 索引能够处理包含多个元素的列，如 [数组](../data-type/array.md)、[JSON](../data-type/json.md)、[HSTORE](../data-type/hstore.md) 等。它可以将列中的元素进行分解和索引，使得可以针对这些元素进行快速查询

3. 查询操作灵活：`GIN` 索引支持一系列操作符和函数，可以进行模糊搜索、前缀搜索、范围搜索等。它提供了强大的查询能力，可以满足各种复杂的查询需求

4. 适用于大型数据集：`GIN` 索引适用于大型数据集，它能够高效地处理大量的索引数据。同时，它还可以通过压缩和位图等技术来减小索引的大小，提高查询性能

5. 部分匹配支持：`GIN` 索引可以支持部分匹配，即可以匹配数据中的一部分而不是整个数据。这对于处理大型文档或包含大量元素的列非常有用

需要注意的是，`GIN` 索引在插入和更新数据时可能会产生一定的性能开销，因为它需要维护索引的结构和元数据。在选择使用 `GIN` 索引时，需要根据具体的数据类型和查询需求进行评估，权衡索引的性能和维护开销

综上所述，`GIN` 索引在全文搜索和多元素列查询方面具有很好的性能，适用于需要处理复杂数据类型和大型数据集的场景

---

在 PostgreSQL 中，可以通过以下步骤来创建 `GIN` 索引：

1. 确定需要创建索引的列和数据类型，例如一个包含 [数组](../data-type/array.md) 元素的列或 [JSON](../data-type/json.md) 列

2. 使用 `CREATE INDEX` 命令创建 `GIN` 索引，如下所示：

    ```sql
    CREATE INDEX index_name ON table_name USING gin (column_name);
    ```

   其中，index_name 是索引的名称，table_name 是要创建索引的表名，column_name 是要创建索引的列名

3. 在查询时使用 `GIN` 索引，例如：

    ```sql
    SELECT * FROM table_name WHERE column_name @> ARRAY['value'];
    ```

以上查询使用了 `GIN` 索引来对数组类型的列进行查询，`@>` 是 `GIN` 索引支持的操作符，表示匹配包含指定元素的行

需要注意的是，使用 `GIN` 索引时需要根据具体的数据类型和查询需求选择合适的操作符和函数。同时，在创建 `GIN` 索引之前，需要对数据进行适当的分析和预处理，以确保索引的有效性和性能

另外，PostgreSQL 还提供了一些 `GIN` 索引相关的配置参数，例如 `gin_fuzzy_search_limit`、`gin_pending_list_limit` 等，可以根据具体的应用场景进行调整和优化

## BRIN 索引

`BRIN`（Block Range INdex）索引是 PostgreSQL 中的一种索引类型，用于处理大数据表的范围查询。它基于数据块的范围信息来构建索引，提供了一种高效的方式来处理具有连续值的列

以下是 `BRIN` 索引的一些特点和使用方法：

1. 数据块范围索引：`BRIN` 索引按照数据表的物理块（block）来划分和组织数据，而不是逐行进行索引。它记录了每个数据块的范围信息，可以通过这些信息快速定位包含特定范围的数据块

2. 适用于有序数据：`BRIN` 索引适用于有序数据列，例如时间戳、连续的数值或其他有序的数据类型。它能够高效地支持范围查询，如大于、小于、范围内等条件

3. 适用于大数据表：`BRIN` 索引在处理大数据表时具有优势，因为它通过对数据块进行索引来减少索引的大小。相比于其他索引类型，`BRIN` 索引需要的存储空间较小，减少了索引维护的开销

4. 不适合频繁更新的场景：由于 `BRIN` 索引是基于块的范围信息构建的，因此在数据块发生变化时，BRIN 索引可能需要进行重建。这使得 `BRIN` 索引不适合频繁更新的场景，而更适合静态或相对稳定的数据

5. 创建 `BRIN` 索引：在 PostgreSQL 中，可以使用以下语法创建 `BRIN` 索引：

    ```sql
    CREATE INDEX index_name ON table_name USING brin (column_name);
    ```

需要注意的是，`BRIN` 索引在处理非有序的数据和范围查询之外的查询时性能可能较差。因此，在选择使用 `BRIN` 索引时，需要考虑数据的有序性和查询模式，并进行综合评估和测试

总而言之，`BRIN` 索引是一种适用于大数据表和范围查询的索引类型。它在提供高效的范围查询性能和较小的索引存储空间方面具有优势，但不适用于频繁更新和非有序数据的场景

## GiST 索引

`GiST`（Generalized Search Tree）索引是 PostgreSQL 中的一种通用搜索树索引类型，用于支持高级的数据类型和自定义操作符的索引。它提供了一种灵活且可扩展的索引方式，适用于各种非传统数据类型和复杂查询需求

以下是 GiST 索引的一些特点和使用方法：

1. 适用于非传统数据类型：`GiST` 索引适用于非传统数据类型，如几何类型、文本类型、网络类型等。它允许用户根据自定义的数据类型定义索引操作符和搜索策略

2. 支持自定义操作符：`GiST` 索引可以使用自定义的操作符进行索引和查询，允许用户根据特定的需求定义索引操作符的行为和语义

3. 多维数据支持：`GiST` 索引支持多维数据的索引和查询。它允许用户创建多个索引组合成一个多维索引，以便进行高效的多维数据搜索和范围查询

4. 可扩展性和自定义性：`GiST` 索引是可扩展和可定制的，允许用户根据具体的数据类型和查询需求开发自定义的索引策略和查询算法

5. 创建 `GiST` 索引：在 PostgreSQL 中，可以使用以下语法创建 `GiST` 索引：

    ```sql
    CREATE INDEX index_name ON table_name USING gist (column_name);
    ```

    这将在 table_name 表的 column_name 列上创建名为 index_name 的 `GiST` 索引

需要注意的是，由于 `GiST` 索引是通用的且具有灵活性，它的性能可能会受到数据类型和索引操作符的影响。在使用 `GiST` 索引时，需要进行适当的配置和优化，以满足特定的查询需求

总而言之，`GiST` 索引是一种灵活、可扩展和适用于非传统数据类型的索引类型。它通过支持自定义操作符和索引策略，使得用户可以根据特定的数据类型和查询需求进行定制化的索引和查询

## SP-GiST 索引

`SP-GiST`（Space-Partitioned Generalized Search Tree）索引是 PostgreSQL 中的一种扩展索引类型，它扩展了 `GiST` 索引的功能，专门用于处理包含空间数据的索引。它适用于几何类型、地理数据和其他具有空间属性的数据类型

以下是 `SP-GiST` 索引的一些特点和使用方法：

1. 空间数据支持：`SP-GiST` 索引专门用于处理包含空间数据的索引需求，如几何类型（点、线、多边形等）和地理数据（经纬度坐标等）等

2. 空间分区：`SP-GiST` 索引使用空间分区策略来组织和管理索引数据。它将空间数据分割为不重叠的空间区域，并为每个区域构建索引，以提供高效的空间数据搜索和查询性能

3. 支持自定义操作符和策略：`SP-GiST` 索引允许用户定义自定义的操作符和策略，以满足特定的空间数据类型和查询需求。用户可以根据需要定义索引操作符的行为和语义

4. 可扩展性和自定义性：`SP-GiST` 索引是可扩展和可定制的，允许用户根据具体的空间数据类型和查询需求开发自定义的索引策略和查询算法

5. 创建 `SP-GiST` 索引：在 PostgreSQL 中，可以使用以下语法创建 `SP-GiST` 索引：

    ```sql
    CREATE INDEX index_name ON table_name USING spgist (column_name);
    ```

    这将在 table_name 表的 column_name 列上创建名为 index_name 的 `SP-GiST` 索引

需要注意的是，`SP-GiST` 索引在处理空间数据类型和空间查询时提供了高效的索引访问，但性能可能会受到具体数据类型和索引操作符的影响。在使用 `SP-GiST` 索引时，需要根据具体的空间数据类型和查询需求进行适当的配置和优化

综上所述，`SP-GiST` 索引是一种扩展的索引类型，专门用于处理包含空间数据的索引需求。它通过空间分区和自定义策略，提供了高效的空间数据搜索和查询性能